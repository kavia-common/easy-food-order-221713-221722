{"is_source_file": true, "format": "TypeScript", "description": "This file defines a Pinia store for managing the shopping cart in a food ordering frontend application. It handles cart state, item management, coupon application, price calculations, and persistence to local storage.", "external_files": ["@/types", "@/services/coupons", "@/services/pricing", "@/services/couponsAdmin", "@/types/coupons", "@/services/pricingConfig"], "external_methods": ["computeTotals", "lineSubtotal", "safeRound2", "computeDeliveryFee", "couponMeetsSubtotal", "findByCode", "validateCouponWithContext", "getDeliveryPricingOptions", "getLocalTimezone"], "published": ["useCartStore"], "classes": [], "methods": [{"name": "function addItem(item: FoodItem, qty = 1) { addItem", "description": "Adds a food item to the cart or increases its quantity, with a maximum of 99.", "scope": "", "scopeKind": ""}, {"name": "function updateQty(id: string, qty: number) { updateQty", "description": "Updates the quantity of a specific cart line item; removes the item if quantity is zero or less.", "scope": "", "scopeKind": ""}, {"name": "removeItem", "description": "Removes a specific item from the cart."}, {"name": "clear", "description": "Clears all items and coupons from the cart."}, {"name": "applyCoupon", "description": "Validates and applies a coupon code, updating the cart state if successful."}, {"name": "removeCoupon", "description": "Removes any applied coupon from the cart."}, {"name": "function canUseStorage(): boolean { canUseStorage", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "function getDefaultTaxRate(): number { getDefaultTaxRate", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "function loadPersisted(): State | null { loadPersisted", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "function schedulePersistDebounced() { schedulePersistDebounced", "scope": "", "scopeKind": "", "description": "unavailable"}], "calls": ["findCouponByCode", "validateCouponWithContext", "computeTotals", "lineSubtotal", "getDeliveryPricingOptions", "getLocalTimezone", "couponMeetsSubtotal"], "search-terms": ["Pinia cart store", "Vue cart management", "coupon validation", "shopping cart state", "price calculation", "localStorage persistence", "cart lines", "delivery fee calculation", "Vue lifecycle"], "state": 2, "file_id": 22, "knowledge_revision": 335, "git_revision": "6122d2fdc0c85ff80fe1fdd913b925f6ea156f24", "revision_history": [{"47": ""}, {"66": "fa51b25a5136c2a213cbe729e4337be0c6b04b4d"}, {"70": "639d0e7d3948f2c942493fe6359c8247bac0bdb5"}, {"236": "cf147ccfbaa9c81ba6b561ab246528cdc11c70ac"}, {"240": "59eba850def3898853840af7e03ece5eabf7887a"}, {"241": "59eba850def3898853840af7e03ece5eabf7887a"}, {"335": "6122d2fdc0c85ff80fe1fdd913b925f6ea156f24"}], "ctags": [{"_type": "tag", "name": "STORAGE_KEY", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^const STORAGE_KEY = 'cart_state_v3'$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "State", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^type State = {$/", "language": "TypeScript", "kind": "alias"}, {"_type": "tag", "name": "addItem", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^  function addItem(item: FoodItem, qty = 1) {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "anyLine", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^      const anyLine = l as any$/", "language": "TypeScript", "kind": "constant", "scope": "updateQty", "scopeKind": "function"}, {"_type": "tag", "name": "appliedCoupon", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^  const appliedCoupon = ref<Coupon | null>(null)$/", "language": "TypeScript", "kind": "constant", "scope": "getDefaultTaxRate", "scopeKind": "function"}, {"_type": "tag", "name": "appliedCouponCode", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^  const appliedCouponCode = ref<string | null>(initial?.couponCode ?? null)$/", "language": "TypeScript", "kind": "constant", "scope": "getDefaultTaxRate", "scopeKind": "function"}, {"_type": "tag", "name": "canUseStorage", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^function canUseStorage(): boolean {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "count", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^  const count = computed(() => lines.value.reduce((sum, l) => sum + l.qty, 0))$/", "language": "TypeScript", "kind": "constant", "scope": "getDefaultTaxRate", "scopeKind": "function"}, {"_type": "tag", "name": "couponError", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^  const couponError = ref<string | null>(null)$/", "language": "TypeScript", "kind": "constant", "scope": "getDefaultTaxRate", "scopeKind": "function"}, {"_type": "tag", "name": "ctx", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^    const ctx: CouponValidationContext = { subtotal: subtotal.value, restaurantIds, restaurantId/", "language": "TypeScript", "kind": "constant", "scope": "updateQty", "scopeKind": "function"}, {"_type": "tag", "name": "deliveryFee", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^  const deliveryFee = computed(() => {$/", "language": "TypeScript", "kind": "constant", "scope": "getDefaultTaxRate", "scopeKind": "function"}, {"_type": "tag", "name": "deliveryOptions", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^  const deliveryOptions = computed(() => getDeliveryPricingOptions())$/", "language": "TypeScript", "kind": "constant", "scope": "getDefaultTaxRate", "scopeKind": "function"}, {"_type": "tag", "name": "discount", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^  const discount = computed(() => totals.value.discount)$/", "language": "TypeScript", "kind": "constant", "scope": "updateQty", "scopeKind": "function"}, {"_type": "tag", "name": "envRate", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^  const envRate = (import.meta as any)?.env?.TAX_RATE ?? (import.meta as any)?.env?.VITE_TAX_RAT/", "language": "TypeScript", "kind": "constant", "scope": "getDefaultTaxRate", "scopeKind": "function"}, {"_type": "tag", "name": "existing", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^    const existing = lines.value.find((l) => l.id === item.id)$/", "language": "TypeScript", "kind": "constant", "scope": "addItem", "scopeKind": "function"}, {"_type": "tag", "name": "found", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^    const found = await findCouponByCode(code)$/", "language": "TypeScript", "kind": "constant", "scope": "updateQty", "scopeKind": "function"}, {"_type": "tag", "name": "getDefaultTaxRate", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^function getDefaultTaxRate(): number {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "ids", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^    const ids = new Set<string>()$/", "language": "TypeScript", "kind": "constant", "scope": "updateQty", "scopeKind": "function"}, {"_type": "tag", "name": "idx", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^    const idx = lines.value.findIndex((l) => l.id === id)$/", "language": "TypeScript", "kind": "constant", "scope": "updateQty", "scopeKind": "function"}, {"_type": "tag", "name": "initial", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^  const initial = loadPersisted()$/", "language": "TypeScript", "kind": "constant", "scope": "getDefaultTaxRate", "scopeKind": "function"}, {"_type": "tag", "name": "l", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^    for (const l of ls) {$/", "language": "TypeScript", "kind": "constant", "scope": "updateQty", "scopeKind": "function"}, {"_type": "tag", "name": "lines", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^  const lines = ref<CartLine[]>(initial?.lines ?? [])$/", "language": "TypeScript", "kind": "constant", "scope": "getDefaultTaxRate", "scopeKind": "function"}, {"_type": "tag", "name": "loadPersisted", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^function loadPersisted(): State | null {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "now", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^  const now = ref<Date>(new Date())$/", "language": "TypeScript", "kind": "constant", "scope": "getDefaultTaxRate", "scopeKind": "function"}, {"_type": "tag", "name": "parsed", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^  const parsed = Number(envRate)$/", "language": "TypeScript", "kind": "constant", "scope": "getDefaultTaxRate", "scopeKind": "function"}, {"_type": "tag", "name": "qtyDebounce", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^  let qtyDebounce: any = null$/", "language": "TypeScript", "kind": "variable"}, {"_type": "tag", "name": "raw", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^    const raw = window.localStorage.getItem(STORAGE_KEY)$/", "language": "TypeScript", "kind": "constant", "scope": "loadPersisted", "scopeKind": "function"}, {"_type": "tag", "name": "restaurantId", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^    const ctx: CouponValidationContext = { subtotal: subtotal.value, restaurantIds, restaurantId/", "language": "TypeScript", "kind": "constant", "scope": "updateQty", "scopeKind": "function"}, {"_type": "tag", "name": "restaurantIds", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^    const ctx: CouponValidationContext = { subtotal: subtotal.value, restaurantIds, restaurantId/", "language": "TypeScript", "kind": "constant", "scope": "updateQty", "scopeKind": "function"}, {"_type": "tag", "name": "restaurantIds", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^    const restaurantIds = deriveRestaurantIdsFromLines(lines.value)$/", "language": "TypeScript", "kind": "constant", "scope": "updateQty", "scopeKind": "function"}, {"_type": "tag", "name": "rid", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^      const rid = anyLine.restaurantId || anyLine.restaurant?.id$/", "language": "TypeScript", "kind": "constant", "scope": "updateQty", "scopeKind": "function"}, {"_type": "tag", "name": "schedulePersistDebounced", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^  function schedulePersistDebounced() {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "tax", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^  const tax = computed(() => totals.value.tax)$/", "language": "TypeScript", "kind": "constant", "scope": "updateQty", "scopeKind": "function"}, {"_type": "tag", "name": "taxRate", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^  const taxRate = ref<number>(initial?.taxRate ?? getDefaultTaxRate())$/", "language": "TypeScript", "kind": "constant", "scope": "getDefaultTaxRate", "scopeKind": "function"}, {"_type": "tag", "name": "total", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^  const total = computed(() => totals.value.total)$/", "language": "TypeScript", "kind": "constant", "scope": "updateQty", "scopeKind": "function"}, {"_type": "tag", "name": "totals", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^  const totals = computed<CartTotals>(() => {$/", "language": "TypeScript", "kind": "constant", "scope": "getDefaultTaxRate", "scopeKind": "function"}, {"_type": "tag", "name": "updateQty", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^  function updateQty(id: string, qty: number) {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "validation", "path": "/home/kavia/workspace/code-generation/easy-food-order-221713-221722/food_ordering_frontend/src/stores/cart.ts", "pattern": "/^    const validation = validateCouponWithContext(found, ctx)$/", "language": "TypeScript", "kind": "constant", "scope": "updateQty", "scopeKind": "function"}], "hash": "71cf306658fb51d77d98925376a077a4", "format-version": 4, "code-base-name": "food_ordering_frontend", "filename": "food_ordering_frontend/src/stores/cart.ts", "fields": [{"name": "let qtyDebounce: any = null", "scope": "", "scopeKind": "", "description": "unavailable"}]}